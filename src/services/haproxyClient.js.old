import { exec } from 'child_process';

const HAPROXY_HOST = process.env.HAPROXY_HOST || 'zlhproxy@100.71.44.12';
const HAPROXY_CFG = '/etc/haproxy/zlh.cfg';

export async function addProxyConfig({ vmid, hostname, externalPort, ctIp, ctPort }) {
  return new Promise((resolve, reject) => {
    const block = `
# --- Auto-generated by ZeroLagHub API ---
listen ${hostname}-${vmid}
    bind 0.0.0.0:${externalPort}
    mode tcp
    option tcplog
    server ${hostname}-${vmid} ${ctIp}:${ctPort}
# --- End of auto-generated block ---
`;

    const cmd = `ssh ${HAPROXY_HOST} "echo '${block.replace(/'/g, "'\\''")}' | sudo tee -a ${HAPROXY_CFG} && sudo systemctl reload haproxy"`;
    exec(cmd, (err, stdout, stderr) => {
      if (err) return reject(stderr || err);
      console.log(`[haproxyClient] Added listener ${hostname}:${externalPort} -> ${ctIp}:${ctPort}`);
      resolve(stdout);
    });
  });
}

export async function removeProxyConfig({ hostname }) {
  const cmd = `ssh ${HAPROXY_HOST} "sudo sed -i '/# --- Auto-generated by ZeroLagHub API ---/,/# --- End of auto-generated block ---/d' ${HAPROXY_CFG} && sudo systemctl reload haproxy"`;
  return new Promise((resolve, reject) => {
    exec(cmd, (err) => {
      if (err) return reject(err);
      console.log(`[haproxyClient] Removed listener ${hostname}`);
      resolve();
    });
  });
}

export default { addProxyConfig, removeProxyConfig };
